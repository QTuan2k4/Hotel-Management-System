<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head('Room Details')}"></head>

<body>
  <div th:replace="~{fragments/nav :: nav}"></div>

  <div class="container py-4">
    <a href="/" class="btn btn-outline-secondary mb-4">
      <i class="bi bi-arrow-left me-2"></i>Back to Rooms
    </a>

    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-lg-7">
            <div class="d-flex align-items-center mb-3">
              <h1 class="h2 fw-bold mb-0 me-3" th:text="${room.name}">Room Name</h1>
              <span class="badge badge-status fs-6" th:classappend="'status-' + ${room.status.toLowerCase()}"
                th:text="${room.status}">AVAILABLE</span>
            </div>

            <div class="row g-3 mb-4">
              <div class="col-sm-6">
                <div class="p-3 bg-light rounded">
                  <div class="text-muted small mb-1"><i class="bi bi-hash me-1"></i>Room Code</div>
                  <div class="fw-bold" th:text="${room.code}">R101</div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="p-3 bg-light rounded">
                  <div class="text-muted small mb-1"><i class="bi bi-tag me-1"></i>Room Type</div>
                  <div class="fw-bold" th:text="${room.type}">DELUXE</div>
                </div>
              </div>
              <div class="col-12">
                <div class="p-3 bg-light rounded">
                  <div class="text-muted small mb-1"><i class="bi bi-currency-dollar me-1"></i>Price per Night</div>
                  <div class="room-price fs-4">
                    <span>$</span><span id="pricePerNight" th:text="${room.pricePerNight}">100</span>
                  </div>
                </div>
              </div>
            </div>

            <div th:if="${room.description}" class="mb-4">
              <h5 class="fw-bold"><i class="bi bi-info-circle me-2"></i>Description</h5>
              <p class="text-muted" th:text="${room.description}"></p>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card bg-light border-0">
              <div class="card-body">
                <h5 class="fw-bold mb-3"><i class="bi bi-calendar-plus me-2"></i>Book This Room</h5>

                <div th:if="${auth != null and auth.loggedIn}">
                  <p class="text-muted small mb-3">Select your check-in and check-out dates to make a reservation.</p>
                  <button id="openDatePicker" class="btn btn-success w-100 py-2">
                    <i class="bi bi-calendar-event me-2"></i>Select Dates to Book
                  </button>
                </div>
                <div th:unless="${auth != null and auth.loggedIn}">
                  <p class="text-muted small mb-3">Please login to book this room.</p>
                  <a href="/login" class="btn btn-primary w-100">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Login to Book
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Date Picker Modal -->
  <div class="modal fade" id="datePickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-calendar-event me-2"></i>Select Your Stay Dates</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle me-1"></i>
            Click on dates to select. <span class="text-danger">Red</span> = Already booked
          </p>

          <div id="dateGrid" class="row row-cols-5 g-2 mb-4">
            <!-- Dates will be populated here -->
          </div>

          <div class="bg-light p-3 rounded mb-3">
            <div class="row">
              <div class="col-6">
                <strong>Selected Nights:</strong> <span id="nightCount" class="text-primary">0</span>
              </div>
              <div class="col-6 text-end">
                <strong>Total:</strong> <span class="room-price">$<span id="totalPrice">0.00</span></span>
              </div>
            </div>
          </div>

          <form id="bookingForm" action="/bookings/create" method="post">
            <input type="hidden" name="roomId" th:value="${room.id}">
            <input type="hidden" name="checkInDate" id="checkInDateInput">
            <input type="hidden" name="checkOutDate" id="checkOutDateInput">
            <button type="submit" id="confirmBtn" class="btn btn-success w-100 py-2" disabled>
              <i class="bi bi-check-circle me-2"></i>Confirm Booking
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script th:inline="javascript">
    (function () {
      const roomId = /*[[${room.id}]]*/ 1;
      const pricePerNight = parseFloat(/*[[${room.pricePerNight}]]*/ 100);

      const modal = new bootstrap.Modal(document.getElementById('datePickerModal'));
      const dateGrid = document.getElementById('dateGrid');
      const nightCountEl = document.getElementById('nightCount');
      const totalPriceEl = document.getElementById('totalPrice');
      const confirmBtn = document.getElementById('confirmBtn');
      const checkInInput = document.getElementById('checkInDateInput');
      const checkOutInput = document.getElementById('checkOutDateInput');

      let bookedDates = [];
      let selectedDates = [];

      // Open modal
      document.getElementById('openDatePicker')?.addEventListener('click', async () => {
        try {
          const resp = await fetch('/api/bookings/booked-dates/' + roomId);
          bookedDates = await resp.json();
        } catch (e) {
          bookedDates = [];
        }
        renderDates();
        modal.show();
      });

      function renderDates() {
        dateGrid.innerHTML = '';
        const today = new Date();

        for (let i = 0; i < 15; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() + i + 1);
          const dateStr = d.toISOString().split('T')[0];
          const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
          const dayNum = d.getDate();
          const monthName = d.toLocaleDateString('en-US', { month: 'short' });

          const isBooked = bookedDates.includes(dateStr);
          const isSelected = selectedDates.includes(dateStr);

          const col = document.createElement('div');
          col.className = 'col';

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.dataset.date = dateStr;
          btn.className = `btn w-100 p-2 ${isBooked ? 'btn-outline-danger disabled' : (isSelected ? 'btn-success' : 'btn-outline-secondary')}`;
          btn.innerHTML = `<div class="small">${dayName}</div><div class="fw-bold">${dayNum}</div><div class="small">${monthName}</div>`;

          if (!isBooked) {
            btn.addEventListener('click', () => toggleDate(dateStr));
          }

          col.appendChild(btn);
          dateGrid.appendChild(col);
        }
      }

      function toggleDate(dateStr) {
        const idx = selectedDates.indexOf(dateStr);
        if (idx >= 0) {
          selectedDates.splice(idx, 1);
        } else {
          selectedDates.push(dateStr);
        }
        selectedDates.sort();
        updateSummary();
        renderDates();
      }

      function updateSummary() {
        const nights = selectedDates.length;
        const total = nights * pricePerNight;

        nightCountEl.textContent = nights;
        totalPriceEl.textContent = total.toFixed(2);

        if (nights > 0) {
          const maxDate = new Date(selectedDates[selectedDates.length - 1]);
          maxDate.setDate(maxDate.getDate() + 1);

          checkInInput.value = selectedDates[0];
          checkOutInput.value = maxDate.toISOString().split('T')[0];
          confirmBtn.disabled = false;
        } else {
          checkInInput.value = '';
          checkOutInput.value = '';
          confirmBtn.disabled = true;
        }
      }
    })();
  </script>
</body>

</html>