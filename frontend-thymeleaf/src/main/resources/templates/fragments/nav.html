<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<nav class="navbar navbar-expand-lg navbar-professional" th:fragment="nav">
  <div class="container">
    <a class="navbar-brand" href="/">
      <i class="bi bi-building me-2"></i>Hotel Management
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">
            <i class="bi bi-house me-1"></i>Rooms
          </a>
        </li>
        <!-- Only show My Bookings and My Invoices for non-admin users -->
        <th:block th:if="${auth != null and auth.loggedIn and !auth.admin}">
          <li class="nav-item">
            <a class="nav-link" href="/bookings/my">
              <i class="bi bi-calendar-check me-1"></i>My Bookings
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/invoices/my">
              <i class="bi bi-receipt me-1"></i>My Invoices
            </a>
          </li>
        </th:block>
      </ul>

      <ul class="navbar-nav">
        <th:block th:if="${auth != null and auth.loggedIn}">
          <!-- Notification Bell (All logged-in users) -->
          <li class="nav-item dropdown me-2">
            <a class="nav-link position-relative" href="#" id="notificationDropdown" role="button"
              data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-bell" style="font-size: 1.2rem;"></i>
              <span id="notificationBadge"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                style="display: none;">
                0
              </span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end notification-dropdown"
              style="width: 320px; max-height: 400px; overflow-y: auto;">
              <li class="dropdown-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">Notifications</span>
                <button id="markAllRead" class="btn btn-sm btn-link text-decoration-none p-0">Mark all read</button>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li id="notificationList">
                <div class="text-center text-muted py-3">
                  <i class="bi bi-bell-slash"></i> No notifications
                </div>
              </li>
            </ul>
          </li>

          <!-- Admin Dashboard (Admin only) -->
          <th:block th:if="${auth.admin}">
            <li class="nav-item me-2">
              <a class="nav-link nav-admin-badge" href="/admin">
                <i class="bi bi-gear-fill me-1"></i>Admin Dashboard
              </a>
            </li>
          </th:block>

          <li class="nav-item">
            <a class="nav-link user-menu fw-bold text-primary" href="/user/dashboard" title="Go to Dashboard">
              <i class="bi bi-person-circle me-1"></i>
              <span th:text="${auth.username}">User</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/logout">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
          </li>
        </th:block>
        <th:block th:unless="${auth != null and auth.loggedIn}">
          <li class="nav-item">
            <a class="nav-link" href="/login">
              <i class="bi bi-box-arrow-in-right me-1"></i>Login
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/register">
              <i class="bi bi-person-plus me-1"></i>Register
            </a>
          </li>
        </th:block>
      </ul>
    </div>
  </div>
</nav>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Notification Polling Script (Admin only) -->
<script th:if="${auth != null and auth.admin}" th:inline="javascript">
  (function () {
    const badge = document.getElementById('notificationBadge');
    const list = document.getElementById('notificationList');
    const markAllBtn = document.getElementById('markAllRead');

    function formatTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = (now - date) / 1000 / 60; // minutes
      if (diff < 1) return 'Just now';
      if (diff < 60) return Math.floor(diff) + 'm ago';
      if (diff < 1440) return Math.floor(diff / 60) + 'h ago';
      return date.toLocaleDateString();
    }

    function getIcon(type) {
      switch (type) {
        case 'BOOKING_CREATED': return 'bi-calendar-plus text-primary';
        case 'PAYMENT_RECEIVED': return 'bi-cash-coin text-success';
        case 'BOOKING_CANCELLED': return 'bi-calendar-x text-danger';
        default: return 'bi-bell text-secondary';
      }
    }

    function fetchNotifications() {
      fetch('/api/notify/admin')
        .then(res => res.json())
        .then(data => {
          const count = data.unreadCount || 0;
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }

          const notifications = data.notifications || [];
          if (notifications.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-bell-slash"></i> No notifications</div>';
          } else {
            list.innerHTML = notifications.slice(0, 10).map(n => `
                        <a href="#" class="dropdown-item notification-item ${n.read ? '' : 'bg-light'}" 
                           onclick="markRead(${n.id})" style="white-space: normal;">
                            <div class="d-flex align-items-start">
                                <i class="bi ${getIcon(n.type)} me-2 mt-1"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-medium">${n.title}</div>
                                    <small class="text-muted">${n.message || ''}</small>
                                    <div class="small text-muted mt-1">${formatTime(n.createdAt)}</div>
                                </div>
                            </div>
                        </a>
                    `).join('');
          }
        })
        .catch(err => console.log('Notification fetch failed:', err));
    }

    window.markRead = function (id) {
      fetch('/api/notify/' + id + '/read', { method: 'POST' })
        .then(() => fetchNotifications());
    };

    markAllBtn?.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      fetch('/api/notify/admin/read-all', { method: 'POST' })
        .then(() => fetchNotifications());
    });

    // Initial fetch
    fetchNotifications();

    // Poll every 30 seconds
    setInterval(fetchNotifications, 30000);
  })();
</script>

<style>
  .notification-dropdown .dropdown-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #eee;
  }

  .notification-dropdown .dropdown-item:last-child {
    border-bottom: none;
  }

  .notification-item:hover {
    background-color: #f8f9fa !important;
  }
</style>

</html>